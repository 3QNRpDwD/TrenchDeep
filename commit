Refactor tensor operations and add new macros